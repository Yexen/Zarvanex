<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ultimate Gotham City - Enhanced 3D Map</title>
  <style>
    body{margin:0;padding:0;background:#0a0a0a;overflow:hidden;font-family:'Arial',sans-serif;}
    #container{width:100vw;height:100vh;position:relative;}
    canvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;pointer-events:auto;}

    #ui{position:absolute;top:20px;left:20px;color:#fff;z-index:1000;max-width:280px;pointer-events:auto;}
    #info{background:rgba(0,0,0,.9);padding:15px;border-radius:8px;border:2px solid #ffd700;margin-bottom:10px;}
    #minimap{width:180px;height:180px;background:rgba(0,0,0,.8);border:2px solid #ffd700;border-radius:8px;position:relative;margin-bottom:10px;}
    .district-dot,.villain-dot{position:absolute;border-radius:50%;transform:translate(-50%,-50%);}
    .district-dot{width:8px;height:8px;}
    .villain-dot{width:6px;height:6px;border:1px solid #f00;}
    .player-dot{position:absolute;width:6px;height:6px;background:#f00;border-radius:50%;transform:translate(-50%,-50%);z-index:10;}

    #locations{background:rgba(0,0,0,.9);padding:10px;border-radius:8px;border:1px solid #333;font-size:10px;margin-bottom:10px;max-height:250px;overflow-y:auto;}
    .location{margin:3px 0;padding:4px;border-radius:3px;cursor:pointer;transition:.3s;}
    .hero-location{background:rgba(0,100,255,.1);border-left:3px solid #0064ff;}
    .villain-location{background:rgba(255,0,0,.1);border-left:3px solid #f00;}
    .neutral-location{background:rgba(255,215,0,.1);border-left:3px solid #ffd700;}
    .location:hover{transform:scale(1.02);opacity:.8;}

    #controls{position:absolute;bottom:20px;left:20px;color:#fff;font-size:10px;z-index:1000;background:rgba(0,0,0,.8);padding:10px;border-radius:5px;pointer-events:auto;}
    #coordinates{position:absolute;bottom:20px;right:20px;color:#ffd700;font-size:11px;background:rgba(0,0,0,.8);padding:10px;border-radius:5px;font-family:monospace;z-index:1000;pointer-events:auto;}

    /* floating 3D labels */
    .label-3d{position:absolute;color:#fff;font-size:12px;background:rgba(0,0,0,.8);padding:4px 8px;border-radius:4px;border:1px solid #ffd700;cursor:pointer;transform:translate(-50%,-100%);white-space:nowrap;z-index:1000;transition:.2s;}
    .label-3d:hover{background:rgba(255,215,0,.2);transform:translate(-50%,-100%) scale(1.1);}
    .villain-label{border-color:#f00!important;color:#f66!important;}
    .villain-label:hover{background:rgba(255,0,0,.2)!important;}
    .hero-label{border-color:#0064ff!important;color:#66aaff!important;}
    .hero-label:hover{background:rgba(0,100,255,.2)!important;}
    .street-label{position:absolute;color:#888;font-size:9px;background:rgba(0,0,0,.6);padding:2px 6px;border-radius:3px;pointer-events:none;white-space:nowrap;z-index:900;}

    /* info card */
    .location-card{position:absolute;background:rgba(0,0,0,.95);border:2px solid #ffd700;border-radius:8px;padding:15px;max-width:340px;color:#fff;font-size:12px;z-index:1100;display:none;box-shadow:0 4px 20px rgba(0,0,0,.8);pointer-events:auto;animation:fadeIn .3s;}
    @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
    .location-card.villain{border-color:#f00;background:rgba(40,0,0,.95);}
    .location-card.hero{border-color:#0064ff;background:rgba(0,0,40,.95);}
    .card-header{display:flex;align-items:center;margin-bottom:10px;font-size:14px;font-weight:bold;}
    .card-icon{font-size:20px;margin-right:8px;}
    .card-threat{margin-left:auto;padding:2px 6px;border-radius:3px;font-size:10px;font-weight:bold;}
    .threat-low{background:#0a0;}
    .threat-medium{background:#aa0;}
    .threat-high{background:#a40;}
    .threat-extreme{background:#a00;animation:pulse 1s infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .card-description{margin:8px 0;line-height:1.4;}
    .card-details{margin:8px 0;font-size:11px;color:#ccc;line-height:1.3;}
    .card-close{position:absolute;top:5px;right:8px;cursor:pointer;color:#999;font-size:18px;font-weight:bold;}
    .card-close:hover{color:#fff;}

    /* small UI button */
    .ui-btn{margin-top:6px;display:inline-flex;align-items:center;gap:6px;padding:6px 10px;font-size:11px;border:1px solid #ffd700;border-radius:6px;background:#0b0b15;color:#ffd700;cursor:pointer;}
    .ui-btn:hover{filter:brightness(1.1);}
  </style>
</head>
<body>
  <div id="container">
    <div id="ui">
      <div id="info">
        <h3 style="margin:0 0 10px 0">ü¶á ULTIMATE GOTHAM - ENHANCED</h3>
        <div id="current-location">Location: Downtown</div>
        <div id="threat-level" style="font-size:10px;margin-top:5px;">Threat Level: LOW</div>
      </div>

      <div id="minimap"><div class="player-dot" id="player-dot"></div></div>

      <div id="locations">
        <div style="font-weight:bold;margin-bottom:5px;">ü¶∏ HERO LOCATIONS</div>
        <div class="location hero-location" data-pos="0,20,-50">üè¢ Financial District</div>
        <div class="location hero-location" data-pos="-30,60,-30">üèóÔ∏è Wayne Tower</div>
        <div class="location hero-location" data-pos="-40,10,40">üëÆ GCPD Headquarters</div>
        <div class="location hero-location" data-pos="-180,25,-120">üè∞ Wayne Manor</div>
        <div class="location hero-location" data-pos="-190,6,-140">ü¶á Batcave</div>
        <div class="location hero-location" data-pos="-100,35,-50">üóº Clock Tower</div>

        <div style="font-weight:bold;margin:10px 0 5px 0;">ü¶π VILLAIN TERRITORIES</div>
        <div class="location villain-location" data-pos="60,15,60">üè• Arkham Asylum</div>
        <div class="location villain-location" data-pos="120,8,-40">üÉè ACE Chemicals</div>
        <div class="location villain-location" data-pos="-120,12,80">üßä Iceberg Lounge</div>
        <div class="location villain-location" data-pos="40,10,-120">üåø Poison Ivy's Lair</div>
        <div class="location villain-location" data-pos="-80,15,120">üòà Two-Face Territory</div>
        <div class="location villain-location" data-pos="160,10,80">‚õìÔ∏è Blackgate Prison</div>
        <div class="location villain-location" data-pos="140,15,-80">üè≠ Sionis Steel Mill</div>

        <div style="font-weight:bold;margin:10px 0 5px 0;">üìç DISTRICTS & LANDMARKS</div>
        <div class="location neutral-location" data-pos="0,5,0">üèõÔ∏è City Hall</div>
        <div class="location neutral-location" data-pos="-60,15,-80">üèòÔ∏è Park Row</div>
        <div class="location neutral-location" data-pos="-25,2,-70">üíÄ Crime Alley</div>
        <div class="location neutral-location" data-pos="-90,5,-90">üå≥ Robinson Park</div>
        <div class="location neutral-location" data-pos="80,10,20">üè≠ Industrial Zone</div>
        <div class="location neutral-location" data-pos="-50,8,100">üåâ The Narrows</div>
        <div class="location neutral-location" data-pos="100,12,120">üé° Amusement Mile</div>
        <div class="location neutral-location" data-pos="-140,10,-10">üèÆ Chinatown</div>
        <div class="location neutral-location" data-pos="50,8,-80">üè´ Gotham University</div>
        <div class="location neutral-location" data-pos="20,15,80">üè• Gotham General Hospital</div>
        <div class="location neutral-location" data-pos="-15,18,-20">üé≠ Monarch Theatre</div>
        <div class="location neutral-location" data-pos="30,20,20">‚õ™ Gotham Cathedral</div>
        <div class="location neutral-location" data-pos="-70,5,20">üì∞ Gotham Gazette</div>
        <div class="location neutral-location" data-pos="65,12,-30">üî¨ S.T.A.R. Labs</div>

        <div style="font-weight:bold;margin:10px 0 5px 0;">üåä WATERWAYS & BRIDGES</div>
        <div class="location neutral-location" data-pos="-150,2,40">üõ∂ North Docks</div>
        <div class="location neutral-location" data-pos="-20,2,10">üõ≥Ô∏è Central Docks</div>
        <div class="location neutral-location" data-pos="110,2,-10">‚õµ South Docks</div>
        <div class="location hero-location" data-pos="-40,6,10">üåâ Wayne Bridge</div>
        <div class="location neutral-location" data-pos="40,6,-5">üåâ Midtown Bridge</div>
        <div class="location villain-location" data-pos="90,6,-15">üåâ ACE Overpass</div>
      </div>
    </div>

    <div id="controls">
      <b>BATMAN CONTROLS:</b><br/>
      WASD: Fly Around | Mouse: Look | Scroll: Zoom<br/>
      Click Districts: Quick Travel | L: Toggle Labels | M: Toggle Minimap<br/>
      <strong>üéØ Click floating labels for intel!</strong><br/>
      <button id="toggle-batsignal" class="ui-btn">üî¶ Bat-Signal: ON</button>
    </div>

    <div id="coordinates">
      <div>X: <span id="coord-x">0</span></div>
      <div>Y: <span id="coord-y">50</span></div>
      <div>Z: <span id="coord-z">100</span></div>
      <div>Street: <span id="current-street">Main St</span></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    let scene, camera, renderer, buildings=[], labels=[];
    let moveForward=false, moveBackward=false, moveLeft=false, moveRight=false;
    let mouseX=0, mouseY=0, isMouseDown=false, showLabels=true;
    let cloudSprites=[];
    // Bat-signal bits
    let batLight, batBeam, batSprite, batSignalOn = true;

    const locations = [
      { name:'Financial District', pos:[0,20,-50], color:0x4a90e2, type:'hero', threat:'low', icon:'üè¢',
        description:'The economic heart of Gotham City, home to Wayne Enterprises and major banks. Gleaming skyscrapers house corporate headquarters.',
        details:'Known for: Corporate offices, Stock exchange, Banking sector<br>Controlled by: Legitimate businesses<br>Active hours: 9 AM - 6 PM<br>Security level: High corporate security<br>Easter egg: Home to the Gotham Stock Exchange heist (Dark Knight Rises)' },
      { name:'Wayne Tower', pos:[-30,60,-30], color:0xffd700, type:'hero', threat:'low', icon:'üèóÔ∏è',
        description:'The towering headquarters of Wayne Enterprises. Also serves as a secret Batman operations base.',
        details:'CEO: Bruce Wayne<br>Height: 150 floors<br>Secret: Advanced R&D labs, Applied Sciences Division<br>Security: Wayne Tech systems, Lucius Fox oversight<br>Fun fact: Penthouse connects to Batcave via private transit tube<br>Notable: Site of Bane takeover attempt' },
      { name:'GCPD Headquarters', pos:[-40,10,40], color:0x0064ff, type:'hero', threat:'low', icon:'üëÆ',
        description:'Gotham City Police Department headquarters with the iconic Bat-Signal on the rooftop.',
        details:'Commissioner: James Gordon<br>Officers: 1200+ active duty<br>Units: MCU (Major Crimes Unit), SWAT, Detectives, CSI<br>Allied with: Batman (unofficial partnership)<br>Famous for: The Bat-Signal on rooftop<br>Notable detectives: Harvey Bullock, Renee Montoya<br>Located on: Kane Street' },
      { name:'City Hall', pos:[0,5,0], color:0xffffff, type:'neutral', threat:'low', icon:'üèõÔ∏è',
        description:"The seat of Gotham's government and political power. Often plagued by corruption.",
        details:'Mayor: Frequently changes due to corruption/murder<br>Services: City planning, Public works<br>Architecture: Classical Beaux-Arts with golden dome<br>Security: Municipal police protection<br>History: Built 1889, site of multiple Riddler schemes<br>Notable: Frequent target of supervillain attacks' },
      { name:'Park Row', pos:[-60,15,-80], color:0x44aa44, type:'neutral', threat:'medium', icon:'üèòÔ∏è',
        description:'A residential district in decline. Contains the infamous Crime Alley.',
        details:'Notable: Crime Alley (Wayne family murder site)<br>Population: Mixed income families, declining<br>Crime rate: Moderate to high<br>History: Former upper-class area, declined after 1930s<br>Known for: Urban decay, abandoned buildings<br>Social issues: Homelessness, gang activity' },
      { name:'Industrial Zone', pos:[80,10,20], color:0x888888, type:'neutral', threat:'medium', icon:'üè≠',
        description:'Factories, warehouses, and docks. Often used by criminals as hideouts.',
        details:'Industries: Manufacturing, Shipping, Steel works<br>Employment: Blue-collar workers, declining jobs<br>Crime: Smuggling, gang activity, arms dealing<br>Notable: Abandoned facilities used by criminals<br>Landmarks: Old subway terminals, warehouse district<br>Active: Dayton & Sons Factory, Gotham Steel Works' },
      { name:'Crime Alley', pos:[-25,2,-70], color:0x220000, type:'neutral', threat:'extreme', icon:'üíÄ',
        description:'The site where Thomas and Martha Wayne were murdered. Bruce Wayne visits this place regularly.',
        details:'Also known as: Park Row (old name), Willis Street<br>Infamous event: Murder of Thomas & Martha Wayne<br>Date of tragedy: June 26<br>Perpetrator: Joe Chill<br>Young witness: 8-year-old Bruce Wayne<br>Current status: Still dangerous, high crime area<br>Memorial: Flowers often placed by Bruce Wayne<br>Nearby: Monarch Theatre exit door' },
      { name:'Robinson Park', pos:[-90,5,-90], color:0x228b22, type:'neutral', threat:'low', icon:'üå≥',
        description:'Gotham\'s largest public park. Beautiful but dangerous at night. Poison Ivy frequently hides here.',
        details:'Size: 250 acres of greenery<br>Features: Gardens, ponds, walking trails<br>Named after: Robinson family (old Gotham founders)<br>Crime: Safe by day, dangerous at night<br>Villain activity: Poison Ivy\'s hideout location<br>Wildlife: Unusual plant growth due to Ivy\'s influence<br>Landmarks: The Great Oak (500 years old)' },
      { name:'Arkham Asylum', pos:[60,15,60], color:0xff4444, type:'villain', threat:'high', icon:'üè•',
        description:"Psychiatric hospital for Gotham's criminally insane. Infamous for its frequent breakouts.",
        details:'Current inmates: Joker, Riddler, Scarecrow, Mad Hatter, Victor Zsasz, Killer Croc<br>Security: Maximum with specialized containment cells<br>Breakout frequency: Disturbingly high (average 2.3 per year)<br>Founded: 1921 by Dr. Amadeus Arkham<br>Director: Dr. Jeremiah Arkham<br>Notable: Built on cursed ground, multiple rebuilds<br>Security levels: Minimum, Maximum, Intensive Treatment' },
      { name:'ACE Chemicals', pos:[120,8,-40], color:0x00ff00, type:'villain', threat:'extreme', icon:'üÉè',
        description:'Abandoned chemical plant where the Joker was created. Highly toxic and unstable.',
        details:'History: Birthplace of the Joker (Red Hood incident)<br>Status: Abandoned since 1989, toxic waste site<br>Dangers: Chemical burns, toxic fumes, unstable structures<br>Contamination: Extremely hazardous - Level 4 biohazard<br>Required: Full hazmat gear, respiratory protection<br>Notable: Vats of acid where Red Hood fell<br>Warning: Condemned by Gotham City - No entry' },
      { name:'Iceberg Lounge', pos:[-120,12,80], color:0x00ffff, type:'villain', threat:'high', icon:'üßä',
        description:"Penguin's upscale nightclub fronting a criminal empire. Ice-themed decor masks dark dealings.",
        details:'Owner: Oswald "Penguin" Cobblepot<br>Cover: High-end nightclub and casino<br>Real business: Money laundering, arms dealing, smuggling<br>Security: Armed thugs disguised as "bouncers"<br>VIP area: Penguin\'s office - criminal nerve center<br>Famous for: Exotic birds, ice sculptures<br>Entry: Members only, password required' },
      { name:"Poison Ivy's Lair", pos:[40,10,-120], color:0x228b22, type:'villain', threat:'high', icon:'üåø',
        description:'Abandoned botanical gardens converted into a toxic greenhouse. Deadly plants guard every entrance.',
        details:'Inhabitant: Dr. Pamela Isley (Poison Ivy)<br>Environment: Overgrown greenhouse complex, tropical climate<br>Dangers: Toxic spores, carnivorous plants, mind-control pheromones<br>Required: Full hazmat protection and antitoxin supply<br>Flora: Mutated Venus flytraps, hybrid species<br>Temperature: 85¬∞F, 95% humidity<br>Warning: Oxygen depleted zones' },
      { name:'Two-Face Territory', pos:[-80,15,120], color:0x800080, type:'villain', threat:'high', icon:'üòà',
        description:'Old courthouse district now ruled by Two-Face. Everything decided by coin flips.',
        details:'Ruler: Harvey "Two-Face" Dent (former District Attorney)<br>Theme: Duality and chance in everything<br>Territory: Old courthouse, Gotham Second Bank<br>Gang: The "Doubles" - split-themed operations<br>Danger: Life-or-death decisions by coin flip<br>Tragedy: Harvey was Gotham\'s White Knight DA<br>Coin: 1922 silver dollar, scarred on one side' },
      { name:'Blackgate Prison', pos:[160,10,80], color:0x2c2c2c, type:'villain', threat:'high', icon:'‚õìÔ∏è',
        description:'Maximum security prison for non-insane criminals. Located on an island in Gotham Bay.',
        details:'Type: Maximum security penitentiary<br>Location: Blackgate Isle<br>Capacity: 2,500 inmates<br>Houses: Carmine Falcone, Rupert Thorne, mob enforcers<br>Security: Armed guards, watchtowers, wall-mounted guns<br>Warden: Warden Quincy Sharp<br>Notable: Frequent riots, gang violence<br>Access: Ferry only from docks' },
      { name:'Clock Tower', pos:[-100,35,-50], color:0xffa500, type:'hero', threat:'low', icon:'üóº',
        description:'Former clocktower converted into Oracle\'s secret headquarters. Barbara Gordon\'s base of operations.',
        details:'Resident: Barbara Gordon / Oracle<br>Function: Information hub for Bat-family<br>Tech: Supercomputers, satellite uplinks, police scanners<br>Height: 12 stories<br>Cover: "Barbara Gordon's apartment"<br>Access: Private elevator, secret entrance<br>Equipment: Oracle database, worldwide surveillance<br>Located: Corner of Finger Avenue and Miller Street' },
      { name:'Sionis Steel Mill', pos:[140,15,-80], color:0x8b0000, type:'villain', threat:'high', icon:'üè≠',
        description:'Abandoned steel mill taken over by Black Mask. Now a base for organized crime.',
        details:'Owner: Roman Sionis / Black Mask<br>Status: Abandoned factory, active criminal base<br>Operations: Torture chamber, weapons cache<br>Gang: False Face Society<br>Danger: Death traps, armed guards<br>History: Sionis family business before Roman\'s fall<br>Notable: Crematorium used for disposing evidence<br>Threat level: Extreme brutality' },
      { name:'The Narrows', pos:[-50,8,100], color:0x4a4a4a, type:'neutral', threat:'extreme', icon:'üåâ',
        description:'Gotham\'s most dangerous district. A crumbling slum island connected by bridges.',
        details:'Status: Condemned district, extreme poverty<br>Crime rate: Highest in Gotham<br>Population: 50,000+ in squalor<br>Infrastructure: Collapsing, 1800s architecture<br>Notable: Scarecrow\'s testing ground<br>Gangs: Multiple territories, constant warfare<br>GCPD presence: Minimal, too dangerous<br>Bridges: Three connecting bridges, often blocked' },
      { name:'Amusement Mile', pos:[100,12,120], color:0xff69b4, type:'neutral', threat:'high', icon:'üé°',
        description:'Abandoned amusement park district. Joker\'s favorite playground and hideout location.',
        details:'Status: Closed since 1985, urban decay<br>Attractions: Rusted Ferris wheel, funhouse, roller coaster<br>Villain: Joker\'s frequent hideout<br>Danger: Deadly "jokes", booby traps everywhere<br>Notable: Ha-Hacienda funhouse<br>History: Once Gotham\'s premiere entertainment district<br>Current: Gang territory, illegal fighting rings<br>Landmarks: 200ft Ferris wheel visible from downtown' },
      { name:'Chinatown', pos:[-140,10,-10], color:0xff0000, type:'neutral', threat:'medium', icon:'üèÆ',
        description:'Gotham\'s Asian district. Vibrant culture mixed with triads and organized crime.',
        details:'Population: 75,000+ residents<br>Culture: Chinese, Japanese, Korean communities<br>Crime: Triad activity, Ghost Dragons gang<br>Landmarks: Dragon Gate arch, numerous restaurants<br>Business: Legitimate shops mixed with illegal gambling<br>Language: Primarily Cantonese, Mandarin<br>GCPD: Detective Crispus Allen assigned here<br>Notable: Best noodles in Gotham' },
      { name:'Gotham University', pos:[50,8,-80], color:0x003366, type:'neutral', threat:'low', icon:'üè´',
        description:'Premier university of Gotham. Many heroes and villains studied here.',
        details:'Founded: 1772<br>Students: 18,000 enrolled<br>Notable alumni: Bruce Wayne, Edward Nygma (Riddler), Harleen Quinzel<br>Departments: Sciences, Law, Medicine, Engineering<br>Campus: 200 acres, Gothic architecture<br>Library: Gotham\'s largest collection<br>Security: Campus police, night patrols<br>Rivalry: Hudson University' },
      { name:'Gotham General Hospital', pos:[20,15,80], color:0xffffff, type:'neutral', threat:'low', icon:'üè•',
        description:'Gotham\'s main hospital. Dr. Leslie Thompkins often works here.',
        details:'Type: Level 1 Trauma Center<br>Staff: 2,500+ medical personnel<br>Beds: 800 patient capacity<br>Notable staff: Dr. Leslie Thompkins (Bruce Wayne\'s friend)<br>Specialty: Trauma from supervillain attacks<br>ER: Constantly overwhelmed<br>Funding: Wayne Foundation major donor<br>Security: 24/7 GCPD presence' },
      { name:'Monarch Theatre', pos:[-15,18,-20], color:0x8b0000, type:'neutral', threat:'medium', icon:'üé≠',
        description:'The movie theater where the Wayne family watched their last film before the tragedy.',
        details:'Infamous event: Wayne family\'s last outing<br>Movie shown: The Mark of Zorro (1940)<br>Date: June 26 (the fateful night)<br>Exit: Leads directly to Crime Alley<br>Current status: Still operational, historic landmark<br>Owner: Changes frequently<br>Bruce Wayne: Avoids this area<br>Memorial: Plaque on side alley wall' },
      { name:'Gotham Cathedral', pos:[30,20,20], color:0xffd700, type:'neutral', threat:'low', icon:'‚õ™',
        description:'Gotham\'s largest cathedral. A sanctuary in the dark city.',
        details:'Built: 1889, Gothic Revival architecture<br>Height: Bell tower 250 feet<br>Capacity: 2,000 people<br>Services: 24/7 sanctuary open<br>Notable: Site of many Gotham weddings/funerals<br>Clergy: Father O\'Malley<br>Events: Frequently targeted by villains<br>Bells: Ring every hour<br>Gargoyles: Famous architectural features' },
      { name:'Gotham Gazette', pos:[-70,5,20], color:0x404040, type:'neutral', threat:'low', icon:'üì∞',
        description:'Gotham\'s primary newspaper. Vicki Vale and Jack Ryder work here.',
        details:'Est: 1881<br>Circulation: 500,000 daily<br>Notable reporters: Vicki Vale, Jack Ryder (The Creeper)<br>Editor: Warren Spacey<br>Known for: Investigative journalism, Batman coverage<br>Rival: Gotham Globe<br>Office: 24/7 operations<br>Slogan: "Gotham\'s Truth"' },
      { name:'S.T.A.R. Labs Gotham', pos:[65,12,-30], color:0x00ffff, type:'neutral', threat:'medium', icon:'üî¨',
        description:'Scientific and Technological Advanced Research Labs. Cutting-edge research facility.',
        details:'Type: Research and development facility<br>Focus: Metahuman studies, advanced tech<br>Security: Level 5 clearance required<br>Staff: 300+ scientists<br>Director: Dr. Sarah Charles<br>Notable: Frequent target of tech thieves<br>Research: Experimental weapons, biotech<br>Funding: Government and Wayne Enterprises<br>Danger: Experimental tech sometimes unstable' },
      { name:'North Docks', pos:[-150,2,40], color:0x1e3a5f, type:'neutral', threat:'low', icon:'üõ∂',
        description:'Cargo piers and warehouses along the northern riverbank.',
        details:'Traffic: Moderate freight, fishing boats<br>Use: Freight and commercial fishing<br>Security: Night patrols by harbor police<br>Access: Loading cranes operational<br>Warehouses: 50+ storage facilities<br>Crime: Occasional smuggling<br>Employment: 500+ dock workers' },
      { name:'Central Docks', pos:[-20,2,10], color:0x1e3a5f, type:'neutral', threat:'low', icon:'üõ≥Ô∏è',
        description:'Busy midtown dock with ferries and barges.',
        details:'Ferry lines: 3 active routes (Blackgate, Narrows, South)<br>Smuggling risk: Medium<br>Shore cranes: 12 operational<br>Security: Regular GCPD patrols<br>Traffic: 200+ vessels daily<br>Commuters: 10,000+ daily ferry passengers<br>Nearby: Fish market, seafood restaurants' },
      { name:'South Docks', pos:[110,2,-10], color:0x1e3a5f, type:'neutral', threat:'medium', icon:'‚õµ',
        description:'Quieter docks near ACE Chemicals. Contaminated waters.',
        details:'Hazards: Chemical runoff from ACE Chemicals<br>Traffic: Low, mostly at night<br>Condition: Water contamination detected<br>Warning: No swimming, no fishing<br>Crime: High smuggling activity<br>Status: EPA monitoring required<br>Gangs: Frequent territory of smugglers<br>Lighting: Poor, many broken streetlights' },
      { name:'Wayne Bridge', pos:[-40,6,10], color:0xffd700, type:'hero', threat:'low', icon:'üåâ',
        description:'Elegant suspension bridge funded by the Wayne family.',
        details:'Design: Suspension bridge, Art Deco style<br>Opened: 1939, funded by Thomas Wayne<br>Patrols: GCPD nightly surveillance<br>Visibility: High security lighting<br>Status: Well-maintained by city<br>Length: 1.2 miles<br>Traffic: 50,000+ vehicles daily<br>Landmark: Gotham postcard icon' },
      { name:'Midtown Bridge', pos:[40,6,-5], color:0xffffff, type:'neutral', threat:'low', icon:'üåâ',
        description:'Main commuter bridge connecting central districts.',
        details:'Lanes: 6 traffic lanes<br>Traffic: Heavy during rush hour (7-9 AM, 5-7 PM)<br>Maintenance: Regular inspections<br>Safety: Standard guardrails<br>Age: Built 1955<br>Toll: $3.50<br>Security: Cameras at both ends<br>Notable: Site of multiple vehicle chases' },
      { name:'ACE Overpass', pos:[90,6,-15], color:0x00ff00, type:'villain', threat:'medium', icon:'üåâ',
        description:'Industrial overpass near ACE Chemicals. Rusting and dangerous.',
        details:'Condition: Rusting infrastructure, poor maintenance<br>Watch: Joker gang activity frequently reported<br>Hazards: Structural concerns, weight limit 10 tons<br>Patrol: Irregular GCPD coverage<br>Age: Built 1965, condemned 2010<br>Status: Still in use despite warnings<br>Danger: Collapse risk, avoid heavy vehicles' },
      { name:'Wayne Manor', pos:[-180,25,-120], color:0x8b4513, type:'hero', threat:'low', icon:'üè∞',
        description:'The ancestral home of the Wayne family, outside Gotham proper. Secret entrance to the Batcave.',
        details:'Owner: Bruce Wayne<br>Built: 1855 by the Wayne family<br>Staff: Alfred Pennyworth (butler and guardian)<br>Secret: Hidden Batcave entrance via grandfather clock<br>Security: Advanced Wayne Tech surveillance systems<br>Grounds: 150 acres, private forest<br>Architecture: Gothic Revival mansion<br>Rooms: 42 rooms including trophy room, library' },
      { name:'Batcave', pos:[-190,6,-140], color:0x222222, type:'hero', threat:'low', icon:'ü¶á',
        description:'Batman\'s secret underground base beneath Wayne Manor. High-tech crime-fighting nerve center.',
        details:'Access: Secret entrance via Wayne Manor grandfather clock<br>Vehicles: Batmobile, Batwing, Batcycle docks & turntables<br>Facilities: Batcomputer, Armory, Forensics Lab, Medical bay<br>Security: Biometric locks, failsafe protocols<br>Power: Underground generator, backup systems<br>Database: Criminal records, case files<br>Training: Combat area, shooting range<br>Notable: Giant penny, dinosaur, Joker card trophies' }
    ];

    const streets = [
      { name:'Wayne Boulevard', direction:'horizontal', position:-30 },
      { name:'Gordon Avenue', direction:'horizontal', position:0 },
      { name:'Penguin Street', direction:'horizontal', position:60 },
      { name:'Batman Drive', direction:'vertical', position:-40 },
      { name:'Main Street', direction:'vertical', position:0 },
      { name:'Joker Lane', direction:'vertical', position:80 },
      { name:'Arkham Road', direction:'horizontal', position:120 },
      { name:'Harvey Dent Way', direction:'vertical', position:-100 },
      // NEW Batman lore-accurate streets
      { name:'Crime Alley (Willis St)', direction:'horizontal', position:-65 },
      { name:'Robinson Park Blvd', direction:'horizontal', position:-90 },
      { name:'Kane Street', direction:'vertical', position:-70 },
      { name:'Finger Avenue', direction:'vertical', position:40 },
      { name:'Miller Street', direction:'horizontal', position:30 },
      { name:'Sprang Road', direction:'vertical', position:110 },
      { name:'Aparo Avenue', direction:'horizontal', position:90 },
      { name:'Dixon Avenue', direction:'vertical', position:-130 },
      { name:'Coventry Road', direction:'horizontal', position:-110 },
      { name:'Old Gotham Road', direction:'vertical', position:150 },
      { name:'Grant Avenue', direction:'horizontal', position:-150 },
      { name:'Tricorner Yards', direction:'vertical', position:-160 },
      { name:'Gotham Avenue', direction:'horizontal', position:150 },
      { name:'Bolland Street', direction:'vertical', position:50 },
      { name:'Robbins Avenue', direction:'horizontal', position:-45 },
      { name:'Monarch Way', direction:'vertical', position:-20 },
    ];

    function init(){
      scene = new THREE.Scene();
      scene.fog = new THREE.Fog(0x0b0b15, 80, 600);

      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
      camera.position.set(0,50,100);

      renderer = new THREE.WebGLRenderer({ antialias:true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x05050b);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      document.getElementById('container').appendChild(renderer.domElement);

      createCity();
      createSky();
      createStars();
      createMoon();
      createClouds();
      createWaterways();

      setupLighting();
      createBatSignal();
      setupControls();
      setupMinimap();
      addStreetLabels();

      animate();
    }

    function createCity(){
      const ground = new THREE.Mesh(new THREE.PlaneGeometry(700,700), new THREE.MeshLambertMaterial({ color:0x141428 }));
      ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

      createStreets();
      locations.forEach(loc => createLocation(loc));
    }

    function createStreets(){
      const streetMat = new THREE.MeshLambertMaterial({ color:0x2a2a2f });
      streets.forEach(street=>{
        if (street.direction==='horizontal'){
          const h = new THREE.Mesh(new THREE.PlaneGeometry(550,4), streetMat);
          h.rotation.x = -Math.PI/2; h.position.set(0,0.1,street.position); scene.add(h);
        } else {
          const v = new THREE.Mesh(new THREE.PlaneGeometry(4,550), streetMat);
          v.rotation.x = -Math.PI/2; v.position.set(street.position,0.1,0); scene.add(v);
        }
      });
    }

    // SKY
    function createSky(){
      const sky = new THREE.Mesh(
        new THREE.SphereGeometry(1200,32,32),
        new THREE.ShaderMaterial({
          side:THREE.BackSide,
          uniforms:{ topColor:{value:new THREE.Color(0x0a0a19)}, bottomColor:{value:new THREE.Color(0x151532)}, offset:{value:33}, exponent:{value:0.8} },
          vertexShader:`varying vec3 vWorldPosition; void main(){ vec4 wp=modelMatrix*vec4(position,1.0); vWorldPosition=wp.xyz; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }`,
          fragmentShader:`uniform vec3 topColor; uniform vec3 bottomColor; uniform float offset; uniform float exponent; varying vec3 vWorldPosition; void main(){ float h=normalize(vWorldPosition+offset).y; float t=max(pow(max(h,0.0),exponent),0.0); gl_FragColor=vec4(mix(bottomColor,topColor,t),1.0); }`
        })
      );
      scene.add(sky);
    }
    function createStars(){
      const starCount=2000, radius=900, positions=new Float32Array(starCount*3);
      for(let i=0;i<starCount;i++){ const phi=Math.acos(2*Math.random()-1), theta=2*Math.PI*Math.random(), r=radius;
        positions[i*3]=r*Math.sin(phi)*Math.cos(theta);
        positions[i*3+1]=r*Math.cos(phi);
        positions[i*3+2]=r*Math.sin(phi)*Math.sin(theta);
      }
      const geo=new THREE.BufferGeometry(); geo.setAttribute('position', new THREE.BufferAttribute(positions,3));
      scene.add(new THREE.Points(geo, new THREE.PointsMaterial({ size:1.1, color:0xffffff })));
    }
    function createMoon(){
      const moon=new THREE.Mesh(new THREE.SphereGeometry(20,32,32), new THREE.MeshPhongMaterial({ color:0xeaeaea, emissive:0x222244, emissiveIntensity:0.2, shininess:5 }));
      moon.position.set(-250,260,-200); scene.add(moon);
      const halo=new THREE.Sprite(new THREE.SpriteMaterial({ color:0x99aaff, transparent:true, opacity:0.2 })); halo.scale.set(120,120,1); halo.position.copy(moon.position); scene.add(halo);
    }
    function createClouds(){
      const c=document.createElement('canvas'); c.width=256; c.height=128; const ctx=c.getContext('2d');
      const g=ctx.createLinearGradient(0,0,256,128); g.addColorStop(0,'rgba(255,255,255,0)'); g.addColorStop(.3,'rgba(255,255,255,.4)'); g.addColorStop(.7,'rgba(255,255,255,.35)'); g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle=g; ctx.beginPath(); ctx.ellipse(128,64,120,50,0,0,Math.PI*2); ctx.fill();
      const tex=new THREE.CanvasTexture(c);
      for(let i=0;i<10;i++){ const sp=new THREE.Sprite(new THREE.SpriteMaterial({ map:tex, depthWrite:false, transparent:true, opacity:.6 }));
        sp.position.set((Math.random()*2-1)*400,120+Math.random()*40,(Math.random()*2-1)*400);
        const s=200+Math.random()*150; sp.scale.set(s,s*.5,1); sp.userData={speed:.02+Math.random()*.03}; scene.add(sp); cloudSprites.push(sp);
      }
    }
    function createWaterways(){
      const riverColor=0x1e3a5f, waterY=.11;
      function seg(x,z,len,deg,width){
        const geo=new THREE.PlaneGeometry(len,width);
        const mat=new THREE.MeshLambertMaterial({ color:riverColor, transparent:true, opacity:.95 });
        const m=new THREE.Mesh(geo,mat); m.rotation.x=-Math.PI/2; m.rotation.z=THREE.MathUtils.degToRad(deg); m.position.set(x,waterY,z); m.receiveShadow=true; scene.add(m);
      }
      // S-curve + branch
      seg(-200,30,180,15,14); seg(-110,20,160,-10,16); seg(-20,10,160,-5,18); seg(70,-5,160,-12,16); seg(160,-15,150,-20,14);
      seg(-160,55,120,35,10);
    }

    // SPECIAL LOCATIONS / BUILDINGS
    function createLocation(location){
      const [x,y,z]=location.pos; let buildingCount, special=false;
      if (location.name==='Wayne Tower'){ createWayneTower(x,y,z); buildingCount=10; special=true; }
      else if (location.name==='Wayne Manor'){ createWayneManor(x,y,z); buildingCount=2; special=true; }
      else if (location.name==='GCPD Headquarters'){ createGCPD(x,y,z); buildingCount=8; special=true; }
      else if (location.name==='Arkham Asylum'){ createArkham(x,y,z); buildingCount=12; special=true; }
      else if (location.name==='ACE Chemicals'){ createACEChemicals(x,y,z); buildingCount=6; special=true; }
      else if (location.name==='Batcave'){ createBatcave(x,y,z); buildingCount=0; special=true; }
      else if (location.name==='Clock Tower'){ createClockTower(x,y,z); buildingCount=4; special=true; }
      else if (location.name==='Blackgate Prison'){ createBlackgate(x,y,z); buildingCount=3; special=true; }
      else if (location.name.includes('Docks')){ createDock(x,y,z,location.name); buildingCount=3; special=true; }
      else if (location.name.includes('Bridge') || location.name.includes('Overpass')){ createBridge(x,y,z,location); buildingCount=2; special=true; }
      else { buildingCount=15; }

      for(let i=0;i<buildingCount;i++){
        const width=Math.random()*8+4, height=Math.random()*40+10, depth=Math.random()*8+4;
        const building=new THREE.Mesh(new THREE.BoxGeometry(width,height,depth), new THREE.MeshLambertMaterial({ color:location.color }));
        let ox, oz;
        do { ox=x+(Math.random()-.5)*80; oz=z+(Math.random()-.5)*80; } while (special && Math.abs(ox-x)<20 && Math.abs(oz-z)<20);
        building.position.set(ox, height/2, oz); building.castShadow=true; building.receiveShadow=true;
        addWindows(building,width,height,depth,location.type);
        scene.add(building); buildings.push(building);
      }
      add3DLabel(location.name, x, y+40, z, location.type, location);
    }
    function createWayneTower(x,y,z){
      const tower=new THREE.Mesh(new THREE.BoxGeometry(15,120,15), new THREE.MeshLambertMaterial({ color:0x2c2c2c }));
      tower.position.set(x,60,z); tower.castShadow=true; scene.add(tower);
      const logo=new THREE.Mesh(new THREE.CylinderGeometry(3,3,2,8), new THREE.MeshBasicMaterial({ color:0xffff00 }));
      logo.position.set(x,121,z); scene.add(logo);
      addWindows(tower,15,120,15,'hero');
    }
    function createGCPD(x,y,z){
      const g=new THREE.Mesh(new THREE.BoxGeometry(25,35,20), new THREE.MeshLambertMaterial({ color:0x0064ff }));
      g.position.set(x,17.5,z); g.castShadow=true; scene.add(g);
      const antenna=new THREE.Mesh(new THREE.CylinderGeometry(.2,.2,15,8), new THREE.MeshBasicMaterial({ color:0xffffff }));
      antenna.position.set(x,42.5,z); scene.add(antenna);
      for(let i=0;i<4;i++){ const car=new THREE.Mesh(new THREE.BoxGeometry(3,1.5,6), new THREE.MeshLambertMaterial({ color:0x000080 })); car.position.set(x+i*4-6,.75,z+15); scene.add(car); }
      addWindows(g,25,35,20,'hero');
    }
    function createArkham(x,y,z){
      const a=new THREE.Mesh(new THREE.BoxGeometry(30,40,25), new THREE.MeshLambertMaterial({ color:0x2c1810 }));
      a.position.set(x,20,z); a.castShadow=true; scene.add(a);
      for(let i=0;i<4;i++){ const t=new THREE.Mesh(new THREE.BoxGeometry(8,50,8), new THREE.MeshLambertMaterial({ color:0x1a1a1a })); const ang=(i/4)*Math.PI*2; t.position.set(x+Math.cos(ang)*20,25,z+Math.sin(ang)*20); t.castShadow=true; scene.add(t); }
      addWindows(a,30,40,25,'villain');
    }
    function createACEChemicals(x,y,z){
      const f=new THREE.Mesh(new THREE.BoxGeometry(35,25,30), new THREE.MeshLambertMaterial({ color:0x228b22 }));
      f.position.set(x,12.5,z); f.castShadow=true; scene.add(f);
      for(let i=0;i<3;i++){ const vat=new THREE.Mesh(new THREE.CylinderGeometry(4,4,8,12), new THREE.MeshLambertMaterial({ color:0x00ff00 })); vat.position.set(x+(i-1)*12,4,z-15); scene.add(vat); }
      addWindows(f,35,25,30,'villain');
    }
    function createClockTower(x,y,z){
      const tower=new THREE.Mesh(new THREE.BoxGeometry(12,60,12), new THREE.MeshLambertMaterial({ color:0x8b6914 }));
      tower.position.set(x,30,z); tower.castShadow=true; scene.add(tower);
      const clock=new THREE.Mesh(new THREE.CylinderGeometry(4,4,1,32), new THREE.MeshBasicMaterial({ color:0xffffff }));
      clock.position.set(x,60,z); clock.rotation.x=Math.PI/2; scene.add(clock);
      addWindows(tower,12,60,12,'hero');
    }
    function createBlackgate(x,y,z){
      const prison=new THREE.Mesh(new THREE.BoxGeometry(35,30,30), new THREE.MeshLambertMaterial({ color:0x2c2c2c }));
      prison.position.set(x,15,z); prison.castShadow=true; scene.add(prison);
      for(let i=0;i<4;i++){ const tower=new THREE.Mesh(new THREE.BoxGeometry(6,40,6), new THREE.MeshLambertMaterial({ color:0x1a1a1a })); const ang=(i/4)*Math.PI*2; tower.position.set(x+Math.cos(ang)*22,20,z+Math.sin(ang)*22); tower.castShadow=true; scene.add(tower); }
      addWindows(prison,35,30,30,'villain');
    }
    function createBatcave(x,y,z){
      const rockMat = new THREE.MeshLambertMaterial({ color:0x303030 });
      const arch = new THREE.Group();
      for (let i=0;i<12;i++){
        const r = 4 + Math.random()*3;
        const s = new THREE.Mesh(new THREE.SphereGeometry(r, 12, 12), rockMat);
        const ang = (i/12) * Math.PI;
        s.position.set(x + Math.cos(ang)*8 + (Math.random()-0.5)*2, y + Math.sin(ang)*4 + Math.random()*1.5, z + (Math.random()-0.5)*4);
        s.castShadow = true; s.receiveShadow = true;
        arch.add(s);
      }
      scene.add(arch);
      const pad = new THREE.Mesh(new THREE.BoxGeometry(16,1,10), new THREE.MeshLambertMaterial({ color:0x1a1a1a }));
      pad.position.set(x, y-0.5, z+2); pad.receiveShadow = true; scene.add(pad);
      const tunnelLen = 28;
      const tunnel = new THREE.Mesh(
        new THREE.CylinderGeometry(6,6,tunnelLen, 24, 1, true),
        new THREE.MeshLambertMaterial({ color:0x151515, side:THREE.DoubleSide })
      );
      tunnel.rotation.z = Math.PI/2;
      tunnel.rotation.y = -Math.PI/8;
      tunnel.position.set(x-8, y-2, z-6);
      tunnel.castShadow = false; tunnel.receiveShadow = false; scene.add(tunnel);
      const wl = new THREE.PointLight(0x66aaff, 0.6, 40); wl.position.set(x, y+6, z+2); scene.add(wl);
    }
    function createDock(x,y,z,name){
      const dock=new THREE.Mesh(new THREE.BoxGeometry(30,2,10), new THREE.MeshLambertMaterial({ color:0x3b3b3b }));
      dock.position.set(x,1.2,z); dock.castShadow=true; dock.receiveShadow=true; scene.add(dock);
    }
    function createBridge(x,y,z,location){
      const length= location.name.includes('Wayne')?44: location.name.includes('ACE')?40:50;
      const color = location.name.includes('Wayne')?0xffd700: location.name.includes('ACE')?0x00ff00:0xffffff;
      const bridge=new THREE.Mesh(new THREE.BoxGeometry(length,3,6), new THREE.MeshLambertMaterial({ color }));
      bridge.position.set(x,6,z); bridge.rotation.y=THREE.MathUtils.degToRad(-10); bridge.castShadow=true; bridge.receiveShadow=true; scene.add(bridge);
    }
    function createWayneManor(x,y,z){
      const manor=new THREE.Mesh(new THREE.BoxGeometry(40,30,35), new THREE.MeshLambertMaterial({ color:0x8b4513 }));
      manor.position.set(x,15,z); manor.castShadow=true; scene.add(manor);
      for(let i=0;i<2;i++){
        const t=new THREE.Mesh(new THREE.BoxGeometry(12,45,12), new THREE.MeshLambertMaterial({ color:0x654321 }));
        t.position.set(x+(i===0?-18:18),22.5,z-10); t.castShadow=true; scene.add(t);
        const roof=new THREE.Mesh(new THREE.ConeGeometry(8,12,8), new THREE.MeshLambertMaterial({ color:0x2f4f2f })); roof.position.set(x+(i===0?-18:18),51,z-10); scene.add(roof);
      }
      const mainRoof=new THREE.Mesh(new THREE.BoxGeometry(42,2,37), new THREE.MeshLambertMaterial({ color:0x2f4f2f })); mainRoof.position.set(x,31,z); scene.add(mainRoof);
      addManorWindows(manor,40,30,35);
    }
    function addWindows(building,w,h,d,type){
      const group=new THREE.Group(); const base = type==='hero'?0x88aaff: type==='villain'?0xff4444:0x444488;
      for(let Y=3;Y<h-2;Y+=4){ for(let X=-w/2+1; X<w/2-1; X+=2){ if (Math.random()>.3){
        const win=new THREE.Mesh(new THREE.PlaneGeometry(.8,1.5), new THREE.MeshBasicMaterial({ color: Math.random()>.7?0xffff88:base, transparent:true, opacity:.8 }));
        win.position.set(X, Y-h/2, d/2+.01); group.add(win);
      }}}
      building.add(group);
    }
    function addManorWindows(building,w,h,d){
      const g=new THREE.Group();
      for(let Y=8; Y<h-5; Y+=12){ for(let X=-w/2+6; X<w/2-6; X+=8){
        const win=new THREE.Mesh(new THREE.PlaneGeometry(3,6), new THREE.MeshBasicMaterial({ color: Math.random()>.4?0xffff88:0x888800, transparent:true, opacity:.9 }));
        win.position.set(X, Y-h/2, d/2+.01); g.add(win);
      }}
      building.add(g);
    }

    function add3DLabel(text,x,y,z,type,locationData){
      const el=document.createElement('div'); el.className='label-3d'; el.textContent=text;
      if (type==='villain') el.classList.add('villain-label'); else if (type==='hero') el.classList.add('hero-label');
      el.addEventListener('click',(e)=>{ e.stopPropagation(); showLocationCard(locationData, e.pageX, e.pageY); });
      el.style.left='50%'; el.style.top='50%';
      document.getElementById('container').appendChild(el);
      labels.push({ element: el, position: new THREE.Vector3(x,y,z), locationData });
    }
    function showLocationCard(location,x,y){
      hideAllLocationCards();
      const card=document.createElement('div'); card.className=`location-card ${location.type}`;
      card.innerHTML=`
        <div class="card-close" onclick="hideAllLocationCards()">√ó</div>
        <div class="card-header"><span class="card-icon">${location.icon||'üìç'}</span>${location.name}
          <span class="card-threat threat-${location.threat}">${(location.threat||'low').toUpperCase()}</span></div>
        <div class="card-description">${location.description||''}</div>
        <div class="card-details">${(location.details||'').replace(/\\n/g,'<br>')}</div>
        <div style="margin-top:10px;font-size:10px;color:#999;">Click anywhere outside to close ‚Ä¢ Move with WASD to explore</div>`;
      card.style.left=Math.min(x,window.innerWidth-360)+'px'; card.style.top=Math.min(y,window.innerHeight-250)+'px'; card.style.display='block';
      card.addEventListener('click',(e)=>e.stopPropagation());
      document.getElementById('container').appendChild(card);
      setTimeout(()=>{ if(card.parentNode) card.remove(); }, 20000);
    }
    function hideAllLocationCards(){ document.querySelectorAll('.location-card').forEach(c=>c.remove()); }
    window.hideAllLocationCards = hideAllLocationCards;

    function addStreetLabels(){
      streets.forEach(st=>{
        const el=document.createElement('div'); el.className='street-label'; el.textContent=st.name; document.getElementById('container').appendChild(el);
        const pos = st.direction==='horizontal' ? new THREE.Vector3(-220,2,st.position) : new THREE.Vector3(st.position,2,-220);
        labels.push({ element: el, position: pos, isStreet:true });
      });
    }

    function setupLighting(){
      scene.add(new THREE.AmbientLight(0x404060, .45));
      const moonLight=new THREE.DirectionalLight(0x99aaff, .7);
      moonLight.position.set(-250,260,-200); moonLight.castShadow=true;
      moonLight.shadow.camera.left=-300; moonLight.shadow.camera.right=300; moonLight.shadow.camera.top=300; moonLight.shadow.camera.bottom=-300;
      scene.add(moonLight);

      locations.forEach(loc=>{
        const pl=new THREE.PointLight(loc.color, .45, 100);
        pl.position.set(loc.pos[0], (loc.pos[1]||10)+20, loc.pos[2]); scene.add(pl);
      });
    }

    // Bat-Signal
    function createBatSignal(){
      const gcpd = locations.find(l=>l.name==='GCPD Headquarters');
      if (!gcpd) return;
      const origin = new THREE.Vector3(gcpd.pos[0], 42, gcpd.pos[2]);
      const targetPos = origin.clone().add(new THREE.Vector3(220, 320, -220));

      batLight = new THREE.SpotLight(0xfff2a8, 2, 900, THREE.MathUtils.degToRad(22), 0.5, 0.9);
      batLight.position.copy(origin);
      batLight.castShadow = true;
      batLight.shadow.mapSize.set(1024,1024);
      batLight.target = new THREE.Object3D();
      batLight.target.position.copy(targetPos);
      scene.add(batLight); scene.add(batLight.target);

      const length = origin.distanceTo(targetPos);
      const beamGeo = new THREE.CylinderGeometry(32, 1.2, length, 24, 1, true);
      const beamMat = new THREE.MeshBasicMaterial({ color:0xfff2a8, transparent:true, opacity:0.15, depthWrite:false, blending:THREE.AdditiveBlending });
      batBeam = new THREE.Mesh(beamGeo, beamMat);

      const dir = new THREE.Vector3().subVectors(targetPos, origin).normalize();
      const mid = origin.clone().add(targetPos).multiplyScalar(0.5);
      batBeam.position.copy(mid);
      const q = new THREE.Quaternion().setFromUnitVectors(new THREE.Vector3(0,1,0), dir);
      batBeam.quaternion.copy(q);
      scene.add(batBeam);

      const tex = makeBatSpriteTexture();
      batSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent:true, opacity:0.9 }));
      batSprite.scale.set(90, 90, 1);
      batSprite.position.copy(targetPos);
      scene.add(batSprite);

      setBatSignal(true);

      const btn = document.getElementById('toggle-batsignal');
      if (btn){
        btn.addEventListener('click', ()=>{
          setBatSignal(!batSignalOn);
        });
      }
    }
    function makeBatSpriteTexture(){
      const s=256; const c=document.createElement('canvas'); c.width=s; c.height=s; const ctx=c.getContext('2d');
      const grad=ctx.createRadialGradient(s/2,s/2,10,s/2,s/2,s/2);
      grad.addColorStop(0,'rgba(255,250,200,1)'); grad.addColorStop(.8,'rgba(255,240,150,.8)'); grad.addColorStop(1,'rgba(255,240,150,0)');
      ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(s/2,s/2,s/2-4,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#000'; ctx.font='bold 150px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('ü¶á', s/2, s/2+8);
      const tex=new THREE.CanvasTexture(c);
      tex.anisotropy = 8;
      return tex;
    }
    function setBatSignal(on){
      batSignalOn = !!on;
      if (batLight) batLight.visible = batSignalOn;
      if (batBeam) batBeam.visible = batSignalOn;
      if (batSprite) batSprite.visible = batSignalOn;
      const btn = document.getElementById('toggle-batsignal');
      if (btn) btn.textContent = batSignalOn ? 'üî¶ Bat-Signal: ON' : 'üî¶ Bat-Signal: OFF';
    }

    // Controls / UI
    function setupControls(){
      document.addEventListener('keydown', (e)=>{
        switch(e.code){
          case 'KeyW': moveForward=true; break;
          case 'KeyS': moveBackward=true; break;
          case 'KeyA': moveLeft=true; break;
          case 'KeyD': moveRight=true; break;
          case 'KeyL': toggleLabels(); break;
          case 'KeyM': toggleMinimap(); break;
        }
      });
      document.addEventListener('keyup', (e)=>{
        switch(e.code){
          case 'KeyW': moveForward=false; break;
          case 'KeyS': moveBackward=false; break;
          case 'KeyA': moveLeft=false; break;
          case 'KeyD': moveRight=false; break;
        }
      });
      renderer.domElement.addEventListener('mousedown', ()=>{ isMouseDown=true; });
      renderer.domElement.addEventListener('mouseup', ()=>{ isMouseDown=false; });
      renderer.domElement.addEventListener('mousemove', (e)=>{
        if (isMouseDown){
          const dx=e.clientX-mouseX, dy=e.clientY-mouseY;
          camera.rotation.y -= dx*0.005; camera.rotation.x -= dy*0.005;
          camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
        }
        mouseX=e.clientX; mouseY=e.clientY;
      });
      renderer.domElement.addEventListener('wheel', (e)=>{
        const factor = 1 + (e.deltaY>0 ? .1 : -.1);
        camera.position.multiplyScalar(factor);
      });
      document.getElementById('container').addEventListener('click', ()=>hideAllLocationCards());
      document.querySelectorAll('.location').forEach(el=>{
        el.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const pos = el.dataset.pos.split(',').map(Number);
          camera.position.set(pos[0], pos[1]+30, pos[2]+50);
          camera.lookAt(pos[0], pos[1], pos[2]);
        });
      });
      window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function setupMinimap(){
      const minimap=document.getElementById('minimap');
      locations.forEach(location=>{
        const dot=document.createElement('div');
        if (location.type==='villain'){ dot.className='villain-dot'; dot.style.backgroundColor = `#${location.color.toString(16).padStart(6,'0')}`; }
        else { dot.className='district-dot'; dot.style.backgroundColor = `#${location.color.toString(16).padStart(6,'0')}`; }
        const mapX=((location.pos[0]+250)/500)*180; const mapZ=((location.pos[2]+250)/500)*180;
        dot.style.left=mapX+'px'; dot.style.top=mapZ+'px'; dot.title=location.name; minimap.appendChild(dot);
      });
    }

    function toggleLabels(){ showLabels=!showLabels; labels.forEach(l=>l.element.style.display = showLabels?'block':'none'); }
    function toggleMinimap(){ const mm=document.getElementById('minimap'); mm.style.display = mm.style.display==='none' ? 'block' : 'none'; }

    function updateUI(){
      document.getElementById('coord-x').textContent=Math.round(camera.position.x);
      document.getElementById('coord-y').textContent=Math.round(camera.position.y);
      document.getElementById('coord-z').textContent=Math.round(camera.position.z);

      cloudSprites.forEach(sp=>{ sp.position.x += sp.userData.speed; if (sp.position.x>420) sp.position.x=-420; });

      const playerDot=document.getElementById('player-dot');
      const mapX=((camera.position.x+250)/500)*180, mapZ=((camera.position.z+250)/500)*180;
      playerDot.style.left=mapX+'px'; playerDot.style.top=mapZ+'px';

      let nearest='Unknown', minDist=Infinity, currentThreat='low';
      locations.forEach(loc=>{
        const d=Math.hypot(camera.position.x-loc.pos[0], camera.position.z-loc.pos[2]);
        if (d<minDist && d<100){ minDist=d; nearest=loc.name; currentThreat=loc.threat; }
      });

      let currentStreet='Unknown Street', streetDist=Infinity;
      streets.forEach(st=>{
        const d = st.direction==='horizontal' ? Math.abs(camera.position.z-st.position) : Math.abs(camera.position.x-st.position);
        if (d<streetDist && d<25){ streetDist=d; currentStreet=st.name; }
      });

      document.getElementById('current-location').textContent = `Location: ${nearest}`;
      document.getElementById('current-street').textContent = currentStreet;
      const threatEl=document.getElementById('threat-level');
      threatEl.textContent = `Threat Level: ${currentThreat.toUpperCase()}`;
      const colors={low:'#00ff00',medium:'#ffff00',high:'#ff8800',extreme:'#ff0000'}; threatEl.style.color=colors[currentThreat]||'#00ff00';
      threatEl.style.fontWeight = currentThreat==='extreme' ? 'bold' : 'normal';

      // project labels
      labels.forEach(l=>{
        const v=l.position.clone(); v.project(camera);
        const x=(v.x*.5+.5)*window.innerWidth, y=(v.y*-.5+.5)*window.innerHeight;
        const dist=camera.position.distanceTo(l.position); const visible = v.z<1 && dist<280;
        if (visible && showLabels){
          l.element.style.left=x+'px'; l.element.style.top=y+'px'; l.element.style.display='block';
          const op=Math.max(.3, 1-(dist/280)); l.element.style.opacity= op; if (l.isStreet){ l.element.style.fontSize='8px'; l.element.style.opacity=op*.5; }
        } else { l.element.style.display='none'; }
      });
    }

    function animate(){
      requestAnimationFrame(animate);
      const speed=2; const dir=new THREE.Vector3();
      dir.z = Number(moveForward)-Number(moveBackward);
      dir.x = Number(moveRight)-Number(moveLeft);
      dir.normalize();
      if (dir.length()>0){
        const e=new THREE.Euler(0,camera.rotation.y,0);
        dir.applyEuler(e); camera.position.add(dir.multiplyScalar(speed));
        camera.position.y = Math.max(5, camera.position.y);
      }

      if (Math.random()>.98){
        buildings.forEach(b=>{
          if (b.children[0] && b.children[0].children.length>0){
            const wins=b.children[0].children; const w=wins[Math.floor(Math.random()*wins.length)]; if (w.material) w.material.opacity = Math.random()*.8+.2;
          }
        });
      }

      updateUI();
      renderer.render(scene,camera);
    }

    init();
  </script>
</body>
</html>
